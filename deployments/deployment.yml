---
- hosts: all
  become: true
  tasks:

  ###############
  # install ufw #
  ###############
  - name: Install ufw firewall
    ansible.builtin.apt:
      name: ufw
      state: present

  #########################################
  # Creating a temp directory on the host #
  #########################################
  - name: Create a temp directory if it does not exist
    ansible.builtin.file:
      path: /temp/grafana-promteheus/
      state: directory
      mode: '0777'

  ######################################
  # Checkout Git Repo for latest code #
  ######################################
  - name: Checkout Git repo in temp directory
    ansible.builtin.git:
      repo: 'https://github.com/gregoryca/grafana-prometheus.git'
      dest: /temp/grafana-prometheus/

  #######################################################
  # Creating a grafana-prometheus directory on the host #
  #######################################################  
  - name: Create the srv directory if it does not exist
    ansible.builtin.file:
      path: /home/gregory/srv/grafana-prometheus/
      state: directory
      mode: '0777'

  #################################################
  # Creating a alertmanager directory on the host #
  #################################################  
  - name: Create the alertmanager directory if it does not exist
    ansible.builtin.file:
      path: /home/gregory/srv/grafana-prometheus/alertmanager/
      state: directory
      mode: '0777'

  #####################################
  # Copy the alertmanager config file #
  #####################################
  - name: copy alertmanager config file to remote server
    copy:
      src: /temp/grafana-prometheus/alertmanager/config.yml
      dest: /home/gregory/srv/grafana-prometheus/alertmanager/config.yml
      remote_src: yes
    loop:
    - config.yml

  #################################################
  # Creating the prometheus directory on the host #
  #################################################
  - name: Create the prometheus directory if it does not exist
    ansible.builtin.file:
      path: /home/gregory/srv/grafana-prometheus/prometheus/
      state: directory
      mode: '0777'

  ###################################
  # Copy the prometheus config file #
  ###################################
  - name: copy prometheus config file to remote server
    copy:
      src: /temp/grafana-prometheus/prometheus/prometheus.yml
      dest: /home/gregory/srv/grafana-prometheus/prometheus/prometheus.yml
      remote_src: yes
    loop:
    - prometheus.yml

  ###################################################
  # Creating a the prometheus directory on the host #
  ###################################################
  - name: Create the grafana directory if it does not exist
    ansible.builtin.file:
      path: /home/gregory/srv/grafana-prometheus/grafana/provisioning/
      state: directory
      mode: '0777'

  ###################################
  # Copy the prometheus config file #
  ###################################
  - name: copy prometheus config file to remote server
    copy:
      src: /temp/grafana-prometheus/grafana/provisioning/datasources/prometheus_ds.yml
      dest: /home/gregory/srv/grafana-prometheus/grafana/provisioning/datasources/prometheus_ds.yml
      remote_src: yes
    loop:
    - prometheus.yml

  #########################
  # Copy the compose file #
  #########################
  - name: copy Docker Compose files to remote server
    copy:
      src: /temp/grafana-prometheus/docker-compose.yml
      dest: /home/gregory/srv/grafana-prometheus/
      remote_src: yes
    loop:
    - docker-compose.yml

  ###############################
  # Copy the elasticsearch file #
  ###############################
  - name: copy elasticsearch files to remote server
    copy:
      src: /temp/grafana-prometheus/elasticsearch.yml
      dest: /home/gregory/srv/grafana-prometheus/
      remote_src: yes
    loop:
    - elasticsearch.yml

  #############################
  # Copy the alert rules file #
  #############################
  - name: copy alert.rules file to remote server
    copy:
      src: /temp/grafana-prometheus/prometheus/alert.rules
      dest: /home/gregory/srv/grafana-prometheus/prometheus/alert.rules
      remote_src: yes
    loop:
    - alert.rules

  #######################
  # Deploy compose file #
  #######################
  - name: deploy Docker Compose stack on remote server
    docker_compose:
      project_src: /home/gregory/srv/grafana-prometheus/
      files:
      - docker-compose.yml
      recreate: always

  #########################################
  # Clean up temp folder after deployment #
  #########################################
  - name: Delete content & directory
    file:
      state: absent
      path: /temp/

  ##################
  # open port 9200 #
  ##################
  - name: Allow all access to port 9200
    ufw:
      rule: allow
      port: '9200'

  ##################
  # open port 9090 #
  ##################
  - name: Allow all access to port 9090
    ufw:
      rule: allow
      port: '9090'

  ##################
  # open port 9100 #
  ##################
  - name: Allow all access to port 9100
    ufw:
      rule: allow
      port: '9100'

  ##################
  # open port 8080 #
  ##################
  - name: Allow all access to port 8080
    ufw:
      rule: allow
      port: '8080'